(function(){"use strict";function createSnapshotController($rootScope,$q,uSync8DashboardService,uSyncSnapshotService,notificationsService,uSyncHub){function createSnapshot(group){vm.createButton.state="busy";vm.working=!0;vm.reported=!1;vm.result="";var promises=[initHub()];$q.all(promises).then(function(){console.log("starting");uSyncSnapshotService.createSnapshot(vm.snapshot.name,vm.snapshot.includeFolders,group,getClientId()).then(function(result){vm.createButton.state="success";vm.reported=!0;vm.result=result.data.fileCount===0?"Empty Snapshot, no changes detected":"Snapshot created "+result.data.fileCount+" changes captured";$rootScope.$broadcast("usync-snapshot-reloaded");notificationsService.success("complete","snapshot created")},function(error){vm.working=!1;vm.createButton.state="error";notificationsService.error("failed",error.data.exceptionMessage)})})}function getHandlerGroups(){uSync8DashboardService.getHandlerGroups().then(function(result){angular.forEach(result.data,function(group,key){vm.createButton.subButtons.push({handler:function(){createSnapshot(group)},labelKey:"usync_create-"+key.toLowerCase()})})})}function initHub(){var defer=$q.defer();return uSyncHub.initHub(function(hub){vm.hub=hub;vm.hub.on("add",function(data){vm.status=data});vm.hub.on("update",function(update){vm.update=update});vm.hub.start(function(result){defer.resolve("complete "+result)})}),defer.promise}function getClientId(){return $.connection!==undefined?$.connection.connectionId:""}var vm=this;vm.working=!1;vm.reported=!1;vm.result="";vm.create=createSnapshot;vm.snapshot={name:"",includeFolders:!0};vm.createButton={state:"init",defaultButton:{labelKey:"usync_create-snapshot",handler:function(){createSnapshot("")}},subButtons:[]};getHandlerGroups()}var createSnapshotComponent={templateUrl:Umbraco.Sys.ServerVariables.application.applicationPath+"App_Plugins/uSyncSnapshots/components/createComponent.html",controllerAs:"vm",controller:createSnapshotController};angular.module("umbraco").component("usyncSnapshotCreate",createSnapshotComponent)})()