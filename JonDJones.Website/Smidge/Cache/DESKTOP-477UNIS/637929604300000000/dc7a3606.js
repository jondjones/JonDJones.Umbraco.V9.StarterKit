(function(){"use strict";function createSnapshotController($rootScope,$q,$scope,uSync8DashboardService,uSyncSnapshotService,eventsService,notificationsService,uSyncHub){function init(){vm.working=!1;vm.reported=!1;vm.result="";vm.create=createSnapshot;vm.snapshot={name:"",includeFolders:!0}}function createSnapshot(group,isFull){vm.createButton.state="busy";vm.working=!0;vm.reported=!1;vm.result="";var promises=[initHub()];$q.all(promises).then(function(){console.log("starting");uSyncSnapshotService.createSnapshot(vm.snapshot.name,vm.snapshot.includeFolders,group,isFull,getClientId()).then(function(result){vm.createButton.state="success";vm.reported=!0;vm.result=result.data.fileCount===0?"Empty Snapshot, no changes detected":"Snapshot created "+result.data.fileCount+" changes captured";$rootScope.$broadcast("usync-snapshot-reloaded");notificationsService.success("complete","snapshot created")},function(error){vm.working=!1;vm.createButton.state="error";notificationsService.error("failed",error.data.exceptionMessage)})})}function getHandlerGroups(){uSync8DashboardService.getHandlerGroups().then(function(result){_.forEach(result.data,function(group,key){key.startsWith("_")||vm.createButton.subButtons.push({handler:function(){createSnapshot(group,!1)},labelKey:"usync_create-"+key.toLowerCase()})});vm.createButton.subButtons.push({handler:function(){createSnapshot("",!0)},labelKey:"usync_create-full"})})}function initHub(){var defer=$q.defer();return uSyncHub.initHub(function(hub){vm.hub=hub;vm.hub.on("add",function(data){vm.status=data});vm.hub.on("update",function(update){vm.update=update});vm.hub.start(function(result){defer.resolve("complete "+result)})}),defer.promise}function getClientId(){return $.connection!==undefined?$.connection.connectionId:""}var vm=this,evts;vm.createButton={state:"init",defaultButton:{labelKey:"usync_create-snapshot",handler:function(){createSnapshot("")}},subButtons:[]};vm.$onInit=function(){getHandlerGroups();init()};evts=[];evts.push(eventsService.on("usync-snapshot.tab.change",function(){vm.reported&&init()}));$scope.$on("$destroy",function(){for(var e in evts)eventsService.unsubscribe(evts[e])})}var createSnapshotComponent={templateUrl:Umbraco.Sys.ServerVariables.application.applicationPath+"App_Plugins/uSyncSnapshots/components/createComponent.html",controllerAs:"vm",controller:createSnapshotController};angular.module("umbraco").component("usyncSnapshotCreate",createSnapshotComponent)})()